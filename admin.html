<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>æ•™å¸«å¾Œå°ç®¡ç†</title>
  
  <script src="config.js"></script>

  <style>
    body { font-family: 'Segoe UI', sans-serif; background: #f4f6f9; padding: 20px; }
    .container { max-width: 1000px; margin: 0 auto; background: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.08); }
    .top-bar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 2px solid #eee; padding-bottom: 15px; }
    .tabs { display: flex; gap: 10px; margin-bottom: 20px; }
    .tab-btn { padding: 10px 20px; border: none; background: #e9ecef; color: #555; cursor: pointer; border-radius: 50px; font-weight: bold; }
    .tab-btn.active { background: #4285F4; color: white; }
    .tab-content { display: none; }
    .tab-content.active { display: block; }
    table { width: 100%; border-collapse: collapse; margin-top: 15px; }
    th { background: #f8f9fa; padding: 12px; text-align: left; border-bottom: 2px solid #ddd; }
    td { padding: 12px; border-bottom: 1px solid #eee; }
    .btn { padding: 6px 12px; border: none; border-radius: 4px; cursor: pointer; color: white; margin-right: 5px; }
    .btn-add { background: #4285F4; width: 100%; padding: 12px; font-size: 16px; margin-bottom: 15px; }
    .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); justify-content: center; align-items: center; }
    .modal-content { background: white; padding: 25px; width: 450px; border-radius: 10px; max-height: 90vh; overflow-y: auto; }
    .form-group { margin-bottom: 12px; }
    label { display: block; font-size: 12px; margin-bottom: 5px; font-weight: bold; }
    input, textarea { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; box-sizing: border-box; }
  </style>
</head>
<body>
  <div class="container">
    <div class="top-bar">
       <h2>ğŸ› ï¸ æ•™å¸«å¾Œå°</h2>
       
       <a href="index.html" style="color:#666;font-size:14px;text-decoration:none;font-weight:bold;border:1px solid #ddd;padding:5px 10px;border-radius:5px;">
       ğŸšª å›é¦–é 
        </a>
       </div>
    <div class="tabs">
      <button class="tab-btn active" onclick="switchTab('questions')">ğŸ“ é¡Œåº«ç®¡ç†</button>
      <button class="tab-btn" onclick="switchTab('records')">ğŸ“Š å­¸ç”Ÿæ¸¬é©—æˆç¸¾</button>
    </div>

    <div id="tab-questions" class="tab-content active">
      <button class="btn btn-add" onclick="openModal('add')">+ æ–°å¢æƒ…å¢ƒé¡Œç›®</button>
      <table id="qTable">
        <thead><tr><th>ID</th><th>é¡Œç›®</th><th>åœ–ç‰‡</th><th>æ“ä½œ</th></tr></thead>
        <tbody id="listArea"><tr><td colspan="4" align="center">è¼‰å…¥ä¸­...</td></tr></tbody>
      </table>
    </div>

    <div id="tab-records" class="tab-content">
      <button class="btn btn-add" style="background:#20bf6b" onclick="loadRecords()">ğŸ”„ é‡æ–°æ•´ç†æˆç¸¾</button>
      <table id="rTable">
        <thead><tr><th>å§“å</th><th>EQ åˆ†æ•¸</th><th>æ™‚é–“</th></tr></thead>
        <tbody id="recordArea"><tr><td colspan="3" align="center">è«‹é»æ“ŠæŒ‰éˆ•è¼‰å…¥...</td></tr></tbody>
      </table>
    </div>
  </div>

  <div id="editModal" class="modal">
    <div class="modal-content">
      <h3 id="modalTitle">ç·¨è¼¯</h3>
      <form id="qForm">
        <input type="hidden" name="qid">
        <div class="form-group"><label>æƒ…å¢ƒæè¿°</label><textarea name="situation" rows="3"></textarea></div>
        <div class="form-group"><label>åœ–ç‰‡ç¶²å€</label><input type="text" name="image"></div>
        <hr>
        <div class="form-group"><label>é¸é … A (åˆ†æ•¸)</label><input type="text" name="optA" placeholder="é¸é …æ–‡å­—"><input type="number" name="scoreA" placeholder="åˆ†æ•¸"></div>
        <div class="form-group"><label>é¸é … B (åˆ†æ•¸)</label><input type="text" name="optB" placeholder="é¸é …æ–‡å­—"><input type="number" name="scoreB" placeholder="åˆ†æ•¸"></div>
        <div class="form-group"><label>é¸é … C (åˆ†æ•¸)</label><input type="text" name="optC" placeholder="é¸é …æ–‡å­—"><input type="number" name="scoreC" placeholder="åˆ†æ•¸"></div>
        
        <button type="button" class="btn" style="background:#20bf6b; width:100%; margin-top:15px;" onclick="saveData()">å„²å­˜</button>
        <button type="button" class="btn" style="background:#ccc; width:100%; margin-top:8px; color:#333;" onclick="closeModal()">å–æ¶ˆ</button>
      </form>
    </div>
  </div>

  <script>
    let allData = []; 
    let mode = 'add';
    
    // --- API å‘¼å«å·¥å…· ---
    function callApi(action, payload = {}) {
        if(typeof CONFIG === 'undefined' || !CONFIG.API_ENDPOINT || CONFIG.API_ENDPOINT.includes("YOUR_SCRIPT_URL")) {
            alert("âš ï¸ è«‹è¨­å®š config.js"); return Promise.reject("Config Error");
        }
        const data = { action: action, ...payload };
        return fetch(CONFIG.API_ENDPOINT, { method: "POST", body: JSON.stringify(data) })
               .then(res => res.json());
    }

    window.onload = function() { 
      loadQuestions(); 
    };
    
    function switchTab(tab) {
      document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
      document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
      event.target.classList.add('active');
      document.getElementById('tab-' + tab).classList.add('active');
      if (tab === 'records') loadRecords();
    }
    
    // --- è¼‰å…¥é¡Œç›® (ä½¿ç”¨ getQuestions API å›å‚³çš„ç‰©ä»¶æ ¼å¼) ---
    function loadQuestions() {
      const tbody = document.getElementById('listArea');
      tbody.innerHTML = '<tr><td colspan="4" align="center">è³‡æ–™è®€å–ä¸­...</td></tr>';

      callApi('getQuestions')
        .then(res => {
          tbody.innerHTML = '';
          if(!res.data || res.data.length === 0) { 
             tbody.innerHTML = '<tr><td colspan="4" align="center">ç„¡è³‡æ–™</td></tr>'; return; 
          }
          
          allData = res.data; // é€™è£¡å­˜çš„æ˜¯ç‰©ä»¶é™£åˆ— [{qid:.., situation:..}, ...]

          allData.forEach(item => {
            // è™•ç†åœ–ç‰‡é¡¯ç¤º
            let imgDisplay = item.image ? `<img src="${item.image}" height="30">` : '<span style="color:#ccc">ç„¡åœ–ç‰‡</span>';
            
            tbody.innerHTML += `
              <tr>
                <td><small>${item.qid}</small></td>
                <td>${item.situation}</td>
                <td>${imgDisplay}</td>
                <td>
                  <button class="btn" style="background:#F6B93B" onclick="editRow('${item.qid}')">ä¿®</button>
                  <button class="btn" style="background:#E55039" onclick="delRow('${item.qid}')">åˆª</button>
                </td>
              </tr>`;
          });
        })
        .catch(err => {
           console.error(err);
           tbody.innerHTML = '<tr><td colspan="4" align="center" style="color:red">è¼‰å…¥å¤±æ•—</td></tr>';
        });
    }

    // --- è¼‰å…¥æˆç¸¾ (åŸæœ¬çš„ getAllRecords å›å‚³çš„æ˜¯ 2D é™£åˆ—) ---
    function loadRecords() {
      const tbody = document.getElementById('recordArea'); 
      tbody.innerHTML = '<tr><td colspan="3" align="center">è¼‰å…¥ä¸­...</td></tr>';
      
      callApi('getAllRecords')
        .then(res => {
          tbody.innerHTML = '';
          const data = res.data;
          // data[0] æ˜¯æ¨™é¡Œï¼Œæ‰€ä»¥å¾ i=1 é–‹å§‹
          if(!data || data.length <= 1) { 
             tbody.innerHTML = '<tr><td colspan="3" align="center">ç„¡æˆç¸¾è³‡æ–™</td></tr>'; return; 
          }
          
          for(let i=1; i<data.length; i++) {
            // æ³¨æ„ï¼šé€™è£¡æ˜¯è®€å–è©¦ç®—è¡¨åŸå§‹æ¬„ä½
            // row[1]=å§“å, row[2]=åˆ†æ•¸, row[3]=æ™‚é–“
            tbody.innerHTML += `
              <tr>
                <td><b>${data[i][1]}</b></td>
                <td><span style="color:green;font-weight:bold">${data[i][2]}</span></td>
                <td>${data[i][3]}</td>
              </tr>`;
          }
        })
        .catch(err => alert("è¼‰å…¥å¤±æ•—ï¼š" + err));
    }

    // --- ç·¨è¼¯åŠŸèƒ½ ---
    function editRow(qid) {
      mode = 'edit'; 
      document.getElementById('modalTitle').innerText = "ç·¨è¼¯é¡Œç›®"; 
      document.getElementById('editModal').style.display = 'flex';
      
      // å¾ç‰©ä»¶é™£åˆ—ä¸­å°‹æ‰¾
      let row = allData.find(r => r.qid == qid);
      if (!row) return;

      let f = document.getElementById('qForm');
      f.qid.value = row.qid;
      f.image.value = row.image;
      f.situation.value = row.situation;
      
      // å› ç‚º API å›å‚³çš„çµæ§‹æ˜¯ options: [{text:.., score:..}, ...]
      // æˆ‘å€‘è¦æŠŠå®ƒæ‹†é–‹å¡«å›è¡¨å–®
      if (row.options && row.options.length >= 3) {
          f.optA.value = row.options[0].text; f.scoreA.value = row.options[0].score;
          f.optB.value = row.options[1].text; f.scoreB.value = row.options[1].score;
          f.optC.value = row.options[2].text; f.scoreC.value = row.options[2].score;
      }
    }

    function openModal() { 
      mode = 'add'; 
      document.getElementById('modalTitle').innerText = "æ–°å¢é¡Œç›®"; 
      document.getElementById('editModal').style.display = 'flex'; 
      document.getElementById('qForm').reset(); 
    }
    
    function closeModal() { document.getElementById('editModal').style.display = 'none'; }

    // --- åˆªé™¤ ---
    function delRow(qid) { 
      if(confirm('ç¢ºå®šè¦åˆªé™¤é€™é¡Œå—ï¼Ÿ')) {
         callApi('deleteQuestion', { qid: qid }).then(() => loadQuestions());
      }
    }

    // --- å„²å­˜ (æ–°å¢æˆ–ä¿®æ”¹) ---
    function saveData() {
      let f = document.getElementById('qForm');
      
      // çµ„åˆè³‡æ–™ (è½‰æˆå¹³é¢æ ¼å¼å‚³çµ¦å¾Œç«¯)
      let data = { 
        qid: f.qid.value, 
        situation: f.situation.value, 
        image: f.image.value, 
        optA: f.optA.value, scoreA: f.scoreA.value, 
        optB: f.optB.value, scoreB: f.scoreB.value, 
        optC: f.optC.value, scoreC: f.scoreC.value 
      };

      const cb = (res) => { 
          if(res.status === 'success') {
             alert('å„²å­˜æˆåŠŸï¼'); 
             closeModal(); 
             loadQuestions(); 
          } else {
             alert('å¤±æ•—ï¼š' + res.message);
          }
      };

      if(mode === 'add') {
         callApi('addQuestion', data).then(cb);
      } else {
         callApi('updateQuestion', data).then(cb);
      }
    }
  </script>
</body>

</html>
